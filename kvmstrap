#!/bin/bash

set -e

BASE="$(dirname "$0")"
SRC="$BASE/rootfs"
DST=/tmp/target
INPUT="${1:-input.qcow2}"
cd "$BASE"
. ./variables

qemu-img resize "$INPUT" 4096M
mkdir -p "$DST"
guestmount -a "$INPUT" -m /dev/sda1 "$DST"
trap 'fusermount -u "$DST"' EXIT

# Add files
rsync -rlpt "$SRC"/etc/{apt,cloud,default,locale.gen,profile.d,skel,ssh,systemd} "$DST"/etc/

# Remove "pass" from fstab
sed -Ei 's/\b[0-9]+$/0/g' "$DST"/etc/fstab

# Remove root password
sed -Ei 's/^(root:)[^:]*(:.*$)/\1\2/' "$DST"/etc/shadow

# Simulate systemctl enable
ln -sfn /etc/systemd/system/vlab-startup.service "$DST"/etc/systemd/system/multi-user.target.wants/vlab-startup.service
